{% extends "base.html" %}

{% block title %}Admin Dashboard - Recommendation System{% endblock %}

{% block content %}
<h2>Admin Dashboard</h2>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ stats.total_users }}</div>
        <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.total_books }}</div>
        <div class="stat-label">Total Books</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.total_ratings }}</div>
        <div class="stat-label">Total Ratings</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ stats.active_users }}</div>
        <div class="stat-label">Active Users (7d)</div>
    </div>
</div>

<div class="card">
    <h3>System Controls</h3>
    <form method="POST" action="{{ url_for('admin_retrain') }}" style="display:inline;">
        <button type="submit" class="btn">Retrain Models</button>
    </form>
    <form method="POST" action="{{ url_for('admin_clear_cache') }}" style="display:inline;">
        <button type="submit" class="btn btn-success">Clear Cache</button>
    </form>
    <form method="GET" action="{{ url_for('admin_health_check') }}" style="display:inline;">
        <button type="submit" class="btn">Health Check</button>
    </form>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div style="margin-top:1rem;">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
</div>

<div class="card">
    <h3>A/B Tests</h3>
    <form method="POST" action="{{ url_for('admin_create_abtest') }}" style="margin-bottom:1rem;">
        <input name="name" placeholder="Test Name" required>
        <input name="algorithm_a" placeholder="Algorithm A" required>
        <input name="algorithm_b" placeholder="Algorithm B" required>
        <input name="traffic_split" type="number" step="0.01" min="0" max="1" value="0.5" required>
        <button type="submit" class="btn">Create A/B Test</button>
    </form>
    <table class="table">
        <thead>
            <tr>
                <th>Test Name</th>
                <th>Algorithm A</th>
                <th>Algorithm B</th>
                <th>Status</th>
                <th>Traffic Split</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for abtest in abtests %}
            <tr>
                <td>{{ abtest.name }}</td>
                <td>{{ abtest.algorithm_a }}</td>
                <td>{{ abtest.algorithm_b }}</td>
                <td>{{ 'Active' if abtest.is_active else 'Stopped' }}</td>
                <td>{{ abtest.traffic_split }}</td>
                <td>
                    {% if abtest.is_active %}
                    <form method="POST" action="{{ url_for('admin_stop_abtest', test_id=abtest.id) }}">
                        <button type="submit" class="btn btn-danger">Stop</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
        {% else %}
            <tr><td colspan="6" style="text-align:center; color:#7f8c8d;">No active A/B tests</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Recent System Activity</h3>
    <div>
        <ul>
        {% for activity in recent_activity %}
            <li>{{ activity }}</li>
        {% else %}
            <li>No recent activity.</li>
        {% endfor %}
        </ul>
    </div>
</div>
{% endblock %}